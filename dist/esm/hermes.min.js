import{request as e}from"http";import{Agent as t,request as o}from"https";import{constants as s,connect as n}from"http2";const{HTTP2_HEADER_PATH:a,HTTP2_HEADER_METHOD:r,HTTP2_HEADER_SCHEME:i,HTTP2_HEADER_AUTHORITY:p}=s;const c=new class{constructor(){this.midia_types=["image","video","audio","font"]}proxyParse(e){var t=e;const o=t.split("://")[0];t.includes("@")?t=t.substring(t.lastIndexOf("@")+1):t.includes("://")&&(t=t.split("://")[1]);const s=t.split(":")[0],n=parseInt(t.split(":")[1]);t=e.split("://")[1],t=e.substring(0,e.lastIndexOf("@"));const[a,r]=t.split(":");return{host:s,port:n,protocol:o||"https",username:a,password:r}}proxyTunnel(t,o,s={},n=15e3){return new Promise(((a,r)=>{const i=new URL(t),p="object"==typeof o?o:this.proxyParse(o);p.username&&(s["Proxy-Authorization"]="Basic "+Buffer.from(p.username+":"+p.password).toString("base64")),e({host:p.host,port:p.port,method:"CONNECT",maxVersion:"TLSv1.3",path:`${i.hostname}:${i.port?i.port:443}`,timeout:n,headers:s}).on("connect",((e,t)=>{200==e.statusCode?a(t):r(e)})).on("error",(e=>r(e))).on("timeout",(e=>r("timeout to connect in proxy"))).end()}))}parseResponseData(e,t){const o=Buffer.concat(e);var s;try{s=JSON.parse(o.toString())}catch(e){s=t["content-type"]&&this.midia_types.some((e=>t["content-type"].includes(e)))?o:o.toString()}return s}async parseOptions(e={}){const o=new URL(e.url),n=Buffer.from("object"==typeof e.payload?JSON.stringify(e.payload):"string"!=typeof e.payload&&e.payload?String(e.payload):e.payload||"");return e.http2?(e.proxy&&(e.socket=await this.proxyTunnel(e.url,e.proxy)),{url:e.url,payload:n,client:{maxVersion:"TLSv1.3",ALPNProtocols:["h2","http/1.1"],socket:e.socket},request:{[p]:o.host,[a]:o.pathname||"/",[i]:o.protocol.split(":")[0],[r]:s[`HTTP2_METHOD_${e.method?.toUpperCase()}`],"Content-Type":e?.headers&&e?.headers["Content-Type"]?e?.headers["Content-Type"]:"text/plain","Content-Length":n.length,Accept:"*/*, image/*",...e?.headers}}):(e.proxy?e.agent=new t({socket:await this.proxyTunnel(e.url,e.proxy).catch((e=>{throw e})),keepAlive:!0}):e.agent=new t(e),{url:e.url,payload:n,request:{origin:o.origin,href:o.href,protocol:o.protocol||"https:",hostname:o.hostname,path:o.pathname||"/",port:o.port||443,method:e.method?.toUpperCase()||"GET",maxVersion:"TLSv1.3",timeout:e.timeout||15e3,headers:{accept:"application/json, text/plain, image/*, */*","accept-language":"en-US,en;q=0.9","Content-Length":n.length,...e?.headers},...e}})}};const{HTTP2_HEADER_STATUS:h}=s;function d(t){return t.http2?function(e){return new Promise((async t=>{const o=await c.parseOptions(e),s=n(o.url,o.client),a=s.request(o.request);a.on("response",(e=>{const o=[];a.on("data",(e=>{o.push(e)})),a.on("end",(()=>{a.close(),s.close(),t({status:e[h],headers:e,data:c.parseResponseData(o,e)})}))})),o.payload?.length>0&&a.write(o.payload),a.end()}))}(t):t.url.includes("http:")?function(t){return new Promise((async(o,s)=>{const n=await c.parseOptions(t),a=e(n.request,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{e.data=c.parseResponseData(t,e.headers),o(e)}))})).on("error",(e=>{s(e)}));n.payload?.length>0&&a.write(n.payload),a.end()}))}(t):function(e){return new Promise((async(t,s)=>{const n=await c.parseOptions(e),a=o(n.request,(e=>{const o=[];e.on("data",(e=>{o.push(e)})),e.on("end",(()=>{e.data=c.parseResponseData(o,e.headers),t(e)}))})).on("error",(e=>{s(e)}));n.payload?.length>0&&a.write(n.payload),a.end()}))}(t)}d.Session=class{constructor(){this.cookies=""}async req(e){const t=this.addCookiesInOptions(e),o=await d(t);try{o.headers["set-cookie"]&&(this.cookies?this.cookies+="; "+o.headers["set-cookie"].map((e=>e.split(";")[0])).join("; "):this.cookies=o.headers["set-cookie"].map((e=>e.split(";")[0])).join("; "))}catch(e){}return o}addCookie(e){return"object"==typeof e?!this.cookies.includes(e.name)&&(this.cookies?(this.cookies=`; ${e.name}=${e.value}`,!0):(this.cookies=`${e.name}=${e.value}`,!0)):!this.cookies.includes(e.split("=")[0])&&(this.cookies?(this.cookies=`; ${e.trim()}`,!0):(this.cookies=`${e.trim()}`,!0))}removeCookie(e){return!!this.cookies.includes(e)&&(this.cookies=this.cookies.replace(this.cookies.slice(this.cookies.indexOf(e)).split(" ")[0],""),!0)}addCookiesInOptions(e){return this.cookies&&(e.headers&&e.headers?.cookie?e.headers.cookie+="; "+this.cookies:e.headers.cookie=this.cookies),e}},["get","post","patch","options","delete","head","put","link","unlink","purge"].forEach((e=>{d[e]=t=>d({...t,method:e})}));export{d as default};
//# sourceMappingURL=hermes.min.js.map
